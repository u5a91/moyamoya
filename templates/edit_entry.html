{% extends "base.html" %}

{% block title %}
    {{ target_date.isoformat() }} のエントリ編集
{% endblock %}

{% block content %}
    <style>
        .panel {
            border: 1px solid #ccc;
            padding: 12px;
            background: #fafafa;
            border-radius: 6px;
        }

        .entry-form {
            max-width: 900px; 
        }

        .form-label {
            display: block;
            margin-top: 10px;
            font-size: 20px;
            font-weight: 600;
        }

        .title-input,
        .body-textarea {
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            line-height: 1.6;
            padding: 10px 12px;
            border: 1px solid #bbb;
            border-radius: 6px;
            background: #fff;
        }

        .title-input {
            font-size: 20px;
            line-height: 1.4;
            font-family: inherit;
        }

        .body-textarea {
            min-height: 320px;
            resize: vertical;
            font-family: inherit;
        }

        .actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .panel img {
            display: block;
            margin: auto;
            max-width: 100%;
        }
    </style>

    <h1>{{ target_date.isoformat() }} のエントリ編集</h1>

    <form method="post" class="entry-form" enctype="multipart/form-data">

        <div>
            <label class="form-label" for="title-input">タイトル</label>
            <input id="title-input" class="title-input" type="text" name="title" placeholder="タイトル">
        </div>
        <div>
            <label class="form-label" for="body-textarea">本文</label>
            <textarea id="body-textarea" class="body-textarea" name="body" placeholder="本文"></textarea>
        </div>
        <div style="margin-top: 16px;">
            <label class="form-label">画像</label>
            <input id="image-input" type="file" accept="image/*">
            <button type="button" id="upload-btn">画像をアップロードして挿入</button>
        </div>
        <div class="actions">
            <button type="submit">保存</button>
        </div>

    </form>

    <!-- プレビュー表示領域 -->
    <div style="margin-top: 16px;" class="entry-form">
        <label class="form-label">プレビュー</label>
        <div id="preview" class="panel">
        </div>
    </div>

    <p style="margin-top: 8px;">
        <a href ="{{ url_for('day_view', date_str=target_date.isoformat()) }}">
            この日のエントリ一覧に戻る
        </a>
        <a href="{{ url_for('index',
                        year=target_date.year,
                        month=target_date.month) }}">
            カレンダーに戻る
        </a>
    </p>
    
    <form method="post"
    action="{{ url_for('delete_entry', entry_id=entry.id) }}"
    onsubmit="return confirm('本当に削除しますか?');"
    style="margin-top: 16px;">
        <button type="submit" style="color: red;">
            この日記を削除する
        </button>
    </form>

    <script>
        // 即時実行関数: 最後に () をつける. スコープ汚染を防ぐための書き方
        (function () {
            const textarea = document.getElementById("body-textarea")
            const preview = document.getElementById("preview")

            if(!textarea || !preview) return;
            
            // 再代入可能
            let timerId = null;

            // 非同期処理
            async function updatePreview() {
                const raw = textarea.value || "";

                try {
                    // HTTP リクエストを投げる
                    const resp = await fetch("{{ url_for('markdown_preview') }}",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ text: raw })
                    });

                    if (!resp.ok) {
                        console.error("preview error", resp.status);
                        return;
                    }

                    // レスポンスのボディを JSON としてパース
                    const data = await resp.json();
                    preview.innerHTML = data.html;

                    if (window.MathJax && window.MathJax.typesetPromise) {
                        MathJax.typesetPromise([preview]);
                    }
                }
                catch (e) {
                    console.error("preview fetch error", e);
                }
            }

            // 200 ms 経ったら実行
            function scheduleUpdate() {
                clearTimeout(timerId);
                timerId = setTimeout(updatePreview, 200);
            }

            // input が発生したら
            textarea.addEventListener("input", scheduleUpdate);

            // 初期表示
            updatePreview();
        })();

        // 画像アップロード用
        (function () {
            const uploadBtn = document.getElementById("upload-btn")
            const imageInput = document.getElementById("image-input")
            const textarea = document.getElementById("body-textarea")

            if (!uploadBtn || !imageInput || !textarea) return;

            uploadBtn.addEventListener("click", async () => {
                if (!imageInput.files.length) {
                    alert("画像ファイルを選択してください");
                    return;
                }

                const formData = new FormData();
                formData.append("image", imageInput.files[0]);

                try {
                    const res = await fetch("{{ url_for('upload_image')}}", {
                        method: "POST",
                        body: formData
                    });

                    const data = await res.json();
                    if (!res.ok) {
                        alert(data.error || "アップロードに失敗しました");
                        return;
                    }

                    const insert = `\n\n<img src="${data.url}" width="500">\n`;
                    textarea.value += insert;

                    // プレビュー更新
                    textarea.dispatchEvent(new Event('input'));
                    imageInput.value = "";
                } catch(e) {
                    console.error(e);
                    alert("通信エラーが発生しました");
                }
            })
        })();
    </script>
{% endblock %}