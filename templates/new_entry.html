{% extends "base.html" %}

{% block title %}新しい日記{% endblock %}

{% block content %}
    <h1>新しい日記</h1>
    <form method="post">
        <input name="title" placeholder="タイトル">
        <br>
        <textarea id="body-textarea" name="body" rows="15" cols="80" placeholder="本文"></textarea>
        <br>
        <button type="submit">保存</button>
    </form>

    <!-- プレビュー表示領域 -->
    <div style="margin-top: 16px;">
        <h2>プレビュー</h2>
        <div id="preview"
                style="border: 1px solid #ccc; padding: 8px; min-height: 150px; background: #fafafa;">
        </div>
    </div>

    <a href="{{ url_for('index') }}">戻る</a>

    <!-- md パーサ: marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- XSS 対策: DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.3/dist/purify.min.js"></script>
    <script>
        // 即時実行関数: 最後に () をつける. スコープ汚染を防ぐための書き方
        (function () {
            const textarea = document.getElementById("body-textarea")
            const preview = document.getElementById("preview")

            if(!textarea || !preview) return;
            
            function updatePreview() {
                const raw = textarea.value || "";
                const dirtyHtml = marked.parse(raw);
                const cleanHtml = DOMPurify.sanitize(dirtyHtml);
                preview.innerHTML = cleanHtml;
            }

            // プレビュー更新
            textarea.addEventListener("input", updatePreview)
            window.addEventListener("DOMContentLoaded", updatePreview)
        })();
    </script>
{% endblock %}