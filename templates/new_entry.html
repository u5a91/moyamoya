{% extends "base.html" %}

{% block title %}新しい日記{% endblock %}

{% block content %}
    <h1>新しい日記</h1>
    <form method="post">
        <input name="title" placeholder="タイトル">
        <br>
        <textarea id="body-textarea" name="body" rows="15" cols="80" placeholder="本文"></textarea>
        <br>
        <button type="submit">保存</button>
    </form>

    <!-- プレビュー表示領域 -->
    <div style="margin-top: 16px;">
        <h2>プレビュー</h2>
        <div id="preview"
                style="border: 1px solid #ccc; padding: 8px; min-height: 150px; background: #fafafa;">
        </div>
    </div>

    <a href="{{ url_for('index') }}">戻る</a>

    <script>
         // 即時実行関数: 最後に () をつける. スコープ汚染を防ぐための書き方
        (function () {
            const textarea = document.getElementById("body-textarea")
            const preview = document.getElementById("preview")

            if(!textarea || !preview) return;
            
            // 再代入可能
            let timerId = null;

            // 非同期処理
            async function updatePreview() {
                const raw = textarea.value || "";

                try {
                    // HTTP リクエストを投げる
                    const resp = await fetch("{{ url_for('markdown_preview') }}",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ text: raw })
                    });

                    if (!resp.ok) {
                        console.error("preview error", resp.status);
                        return;
                    }

                    // レスポンスのボディを JSON としてパース
                    const data = await resp.json();
                    preview.innerHTML = data.html;

                    // 無事読み込まれたら再描画
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        MathJax.typesetPromise([preview]);
                    }
                }
                catch (e) {
                    console.error("preview fetch error", e);
                }
            }

            // 200 ms 経ったら実行
            function scheduleUpdate() {
                clearTimeout(timerId);
                timerId = setTimeout(updatePreview, 200);
            }

            // input が発生したら
            textarea.addEventListener("input", scheduleUpdate);

            // 初期表示
            updatePreview();
        })();

    </script>
{% endblock %}