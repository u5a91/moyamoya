{% extends "base.html" %}

{% block title %}{{ year }} 年 {{ month }} 月 カレンダー{% endblock %}

{% block content %}
    <h1>{{ year }} 年 {{ month }} 月 カレンダー</h1>
    <p>
        <a href="{{ url_for('new_entry') }}">新しい日記を書く</a>
        <a href="{{ url_for('logout') }}">ログアウト</a>
    </p>

    <div class="month-nav">
        <a href ="{{ url_for(
                'index',
                year=(year - 1 if month == 1 else year), 
                month=(12 if month == 1 else month - 1) 
            ) }}">
            前の月
        </a>
        |    
        <a href ="{{ url_for(
                'index',
                year=(year + 1 if month == 12 else year), 
                month=(1 if month == 12 else month + 1) 
            ) }}">
            次の月
        </a>
    </div>

    <table class="calendar">
        <tr>
            <th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th>
        </tr>
        {% for week in weeks %}
            <tr>
                {% for day in week %}
                    {% set day_entries = entries_by_date.get(day, []) %}
                    {% set count = day_entries|length %}
                    {# Jinja2 特有の記法 #}
                    {% set c = [count, 9]|min %}
                    {% set t = ((c - 1) // 4 + 1) / 3 %}
                    
                    {# 最大色 #}
                    {% set rmax, gmax, bmax = 0, 80, 255 %}

                    {% set r = (255*(1 - t) + rmax*t)|round|int %}
                    {% set g = (255*(1 - t) + gmax*t)|round|int %}
                    {% set b = (255*(1 - t) + bmax*t)|round|int %}

                    {% set bg = "rgb(" ~ r ~ "," ~ g ~ "," ~ b ~ ")" %}
                        <td
                            {% if day.month != month %}
                            style="background:#eee"
                            {% else %}
                            style="background: {{ bg }}"
                            {% endif %}
                        >
                        <div class="calendar-date">
                            <a href="{{ url_for('day_view', date_str=day.isoformat()) }}">
                                {{ day.day }}
                            </a>
                        </div>
                        {% if count %}
                            <div style="font-size: 0.8em">
                                {{ count }} 件
                            </div>
                        <!-- 各エントリへのリンク -->
                        <div style="font-size: 0.7em; margin-top: 2px;">
                            {% for entry in day_entries[:3] %}
                                <div>
                                    <a href="{{ url_for(
                                                'entry_view',
                                                date_str=day.isoformat(),
                                                entry_id=entry.id
                                            ) }}">
                                        {{ entry.title or "無題" }}
                                    </a>
                                </div>
                            {% endfor %}
                            {% if count > 3 %}
                                <div>:</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
    </table>
{% endblock %}